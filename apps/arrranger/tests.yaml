schemaVersion: 2.0.0

metadataTest:
  env:
    - key: CONFIG_DIR
      value: /config
    - key: DATA_DIR
      value: /data
    - key: CONFIG_FILE
      value: /config/arrranger_instances.json
    - key: DB_NAME
      value: /data/arrranger.db
    - key: PYTHONUNBUFFERED
      value: "1"
    - key: VIRTUAL_ENV
      value: /app/.venv
  labels:
    - key: "org.opencontainers.image.title"
      value: "arrranger"
  exposedPorts: []
  volumes:
    - /config
    - /data
  entrypoint: ["/usr/local/bin/entrypoint.sh"]
  cmd: ["uv", "run", "arrranger_sync.py"]
  workdir: /app

fileExistenceTests:
  - name: 'Check entrypoint.sh'
    path: '/usr/local/bin/entrypoint.sh'
    shouldExist: true
    permissions: '-rwxr-xr-x'
  - name: 'Check arrranger_sync.py'
    path: '/app/arrranger_sync.py'
    shouldExist: true
  - name: 'Check arrranger_scheduler.py'
    path: '/app/arrranger_scheduler.py'
    shouldExist: true
  - name: 'Check arrranger_instances.json.example'
    path: '/app/arrranger_instances.json.example'
    shouldExist: true
  - name: 'Check pyproject.toml'
    path: '/app/pyproject.toml'
    shouldExist: true
  - name: 'Check uv.lock'
    path: '/app/uv.lock'
    shouldExist: true
  - name: 'Check gosu'
    path: '/usr/bin/gosu'
    shouldExist: true
    permissions: '-rwxr-xr-x'

commandTests:
  - name: "Check python version"
    command: "python"
    args: ["--version"]
    expectedOutput: ["Python 3.12.*"]
  - name: "Check uv version"
    command: "uv"
    args: ["--version"]
    exitCode: 0
  - name: "Check gosu execution"
    command: "gosu"
    args: ["arrranger", "whoami"]
    expectedOutput: ["arrranger"]
  - name: "Test entrypoint script help (simulated)"
    command: "/usr/local/bin/entrypoint.sh"
    args: ["uv", "run", "arrranger_sync.py", "--help"]
    exitCode: 0